{% extends 'base.html' %}

{% block title %}{{ book.title }} - FlipBook{% endblock %}

{% block extra_css %}
<style>
    body { overflow: hidden; }
    .flipbook-viewer { position: fixed; top: 80px; left: 0; right: 0; bottom: 0; background: #2d3748; display: flex; flex-direction: column; }
    .viewer-header { background: rgba(153, 152, 152, 0.95); padding: 35px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; flex-wrap: wrap; }
    .bookmark-section { margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); display: flex; gap: 10px; align-items: center; }
    @media (max-width: 768px) {
        .viewer-header { flex-direction: column; align-items: stretch; gap: 10px; padding: 10px 8px; }
        .bookmark-section { margin-left: 0; padding-left: 0; border-left: none; justify-content: flex-end; }
    }
    .viewer-title { font-size: 18px; font-weight: 600; color: #333; }
    .viewer-back { text-decoration: none; color: #2c53fd; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: color 0.3s; }
    .viewer-back:hover { color: #0cb3e6; }
    .viewer-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; overflow-y: auto; overflow-x: hidden; position: relative; width: 100%; background: #FAF3E1; }
    .flipbook-container { position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; flex-shrink: 0; overflow: visible; }
    #flipbook { margin: 0 auto; }
    #flipbook .page { background: white; box-shadow: 0 0 20px rgba(0, 0, 0, 0.2); }
    #flipbook .page img { width: 100%; height: 73%; object-fit: contain; display: block; image-rendering: crisp-edges; image-rendering: -webkit-optimize-contrast; }
    /* Side Navigation Buttons */
    .side-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #125bfa4d 0%, #4083ff4d 100%); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 5px 20px rgba(18, 91, 250, 0.3); z-index: 100; }
    .side-nav-btn:hover:not(:disabled) { background: linear-gradient(135deg, #0d48a19f 0%, #2566e848 100%); transform: translateY(-50%) scale(1.1); }
    .side-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    #prev-side-btn { position: fixed; left: 20px; }
    #next-side-btn { position: fixed; right: 20px; }
    .controls { position: relative; bottom: auto; left: auto; transform: none; background: linear-gradient(135deg, #125bfa 0%, #4083ff 100%); backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 50px; display: flex; gap: 15px; align-items: center; box-shadow: 0 5px 30px rgba(250, 129, 18, 0.3); z-index: 9999; margin-bottom: 30px; flex-shrink: 0; }
    .control-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .control-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
    .control-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .page-counter { color: white; font-weight: 600; font-size: 14px; min-width: 80px; text-align: center; padding: 0 15px; }
    .jump-to-page { display: flex; gap: 6px; margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); align-items: center; }
    #jump-page-input { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 60px; padding: 8px 10px; border-radius: 6px; font-size: 13px; font-weight: 600; text-align: center; transition: all 0.3s ease; }
    #jump-page-input:focus { outline: none; background: rgba(255, 255, 255, 0.25); border-color: rgba(255, 255, 255, 0.6); }
    #jump-page-input::placeholder { color: rgba(255, 255, 255, 0.5); }
    .zoom-controls { display: flex; gap: 10px; margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); }
    .fullscreen-btn { margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); }
    .bookmark-section { margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); display: flex; gap: 10px; align-items: center; }
    .control-btn.bookmark-btn { background: rgba(255, 255, 255, 0.1); }
    .control-btn.bookmark-btn.active { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
    .bookmark-panel { position: fixed; top: 80px; right: -350px; width: 350px; height: calc(100vh - 80px); background: white; box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2); z-index: 9990; transition: right 0.3s ease; overflow-y: auto; display: flex; flex-direction: column; }
    .bookmark-panel.open { right: 0; }
    .bookmark-panel-header { padding: 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; font-weight: 700; font-size: 18px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .bookmark-panel-header button { background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .bookmark-panel-header button:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
    .bookmark-list { flex: 1; padding: 10px; overflow-y: auto; }
    .bookmark-item { padding: 12px 15px; margin-bottom: 8px; background: #f9fafb; border-left: 4px solid #fbbf24; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
    .bookmark-item:hover { background: #f3f4f6; transform: translateX(5px); box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2); }
    .bookmark-item-info { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .bookmark-item-title { font-weight: 600; color: #333; font-size: 14px; }
    .bookmark-item-page { font-size: 12px; color: #999; }
    .bookmark-item-delete { background: #fee2e2; color: #dc2626; border: none; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 14px; }
    .bookmark-item-delete:hover { background: #fecaca; }
    .bookmark-empty { text-align: center; padding: 40px 20px; color: #999; }
    .bookmark-empty i { font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5; }
    .bookmark-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0); z-index: 9989; transition: background 0.3s ease; display: none; }
    .bookmark-overlay.active { background: rgba(0, 0, 0, 0.3); display: block; }
    .loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 48px; animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
    @keyframes slideUp { from { transform: translateX(-50%) translateY(20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
    @media (max-width: 768px) {
        .flipbook-viewer { top: 70px; }
        .viewer-header { padding: 60px 15px; }
        .viewer-header { margin: 0px 0px -53px; }
        .viewer-title { font-size: 16px; }
        .viewer-content { padding: 10px; flex-direction: column; }
        .flipbook-container { max-width: 100%; max-height: 75vh; padding: 0 10px; overflow: visible; }
        #prev-side-btn { display: flex !important; width: 40px; height: 40px; font-size: 16px; left: 10px; z-index: 1000; }
        #next-side-btn { display: flex !important; width: 40px; height: 40px; font-size: 16px; right: 10px; z-index: 1000; }
        .controls {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 8px;
            gap: 4px;
            flex-wrap: nowrap;
            justify-content: flex-start;
            border-radius: 25px;
            width: 98vw;
            max-width: 100vw;
            margin: 0;
            overflow-x: auto;
            overflow-y: visible;
            display: flex;
            align-items: center;
            scrollbar-width: none;
        }
        .controls::-webkit-scrollbar { display: none; }
        .jump-to-page { display: flex; min-width: 120px; }
        .jump-to-page input { min-width: 60px; }
        .page-counter { min-width: 60px; }
        .zoom-controls { min-width: 80px; }
        .control-btn { width: 38px; height: 38px; font-size: 13px; flex-shrink: 0; min-width: 38px; }
        .page-counter { font-size: 12px; min-width: 65px; padding: 0 10px; flex-shrink: 0; white-space: nowrap; }
        /* .jump-to-page { display: none; } */
        .zoom-controls { margin-left: 5px; padding-left: 5px; border-left: 1px solid rgba(255, 255, 255, 0.2); gap: 5px; }
        .fullscreen-btn { margin-left: 5px; padding-left: 5px; border-left: 1px solid rgba(255, 255, 255, 0.2); }
    }
    @media (max-width: 480px) {
        .flipbook-viewer { top: 60px; }
        .flipbook-container { padding: 0 10px; max-height: 70vh; }
        #prev-side-btn { width: 38px; height: 38px; font-size: 14px; left: 8px; }
        #next-side-btn { width: 38px; height: 38px; font-size: 14px; right: 8px; }
        .controls {
            bottom: 8px;
            padding: 8px 4px;
            gap: 3px;
            width: 99vw;
            max-width: 100vw;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: visible;
            display: flex;
            align-items: center;
            scrollbar-width: none;
        }
        .controls::-webkit-scrollbar { display: none; }
        .jump-to-page { min-width: 110px; }
        .jump-to-page input { min-width: 50px; }
        .page-counter { min-width: 50px; }
        .zoom-controls { min-width: 60px; }
        .control-btn { width: 36px; height: 36px; font-size: 12px; min-width: 36px; }
        .page-counter { font-size: 11px; min-width: 55px; padding: 0 5px; }
        .zoom-controls { margin-left: 3px; padding-left: 3px; gap: 3px; }
        .zoom-controls .control-btn { display: inline-flex; }
        .fullscreen-btn { margin-left: 3px; padding-left: 3px; }
    }
</style>
{% endblock %}

{% block content %}

<div class="flipbook-viewer">
    <div class="viewer-header">
        <a href="{% url 'home' %}" class="viewer-back"><i class="fas fa-arrow-left"></i> Back to Library</a>
        <div class="viewer-title">{{ book.title }}</div>
        <div class="bookmark-section" style="margin-left:auto; display:flex; gap:10px; align-items:center;">
            <button class="control-btn bookmark-btn" id="bookmark-btn" title="Add Bookmark"><i class="fas fa-bookmark"></i></button>
            <button class="control-btn" id="show-bookmarks" title="Show Bookmarks"><i class="fas fa-bars"></i></button>
        </div>
    </div>
    <div class="viewer-content" id="viewer-content">
        <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
        <div class="flipbook-container" id="flipbook-wrapper" style="display: none;">
            <button class="side-nav-btn" id="prev-side-btn" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
            <div id="flipbook">
                {% for page in pages_list %}
                <div class="page" data-page="{{ forloop.counter }}"></div>
                {% endfor %}
            </div>
            <button class="side-nav-btn" id="next-side-btn" title="Next Page"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="controls">
            <button class="control-btn" id="prev-btn" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
            {% comment %} <button class="control-btn" id="first-btn" title="First Page"><i class="fas fa-step-backward"></i></button> {% endcomment %}
            <div class="page-counter"><span id="current-page">1</span> / <span id="total-pages">{{ total_pages }}</span></div>
            {% comment %} <button class="control-btn" id="last-btn" title="Last Page"><i class="fas fa-step-forward"></i></button> {% endcomment %}
            <button class="control-btn" id="next-btn" title="Next Page"><i class="fas fa-chevron-right"></i></button>
            <div class="jump-to-page">
                <input type="number" id="jump-page-input" placeholder="Go to page" title="Jump to Page" min="1" max="{{ total_pages }}">
                <button class="control-btn" id="jump-page-btn" title="Jump to Page"><i class="fas fa-arrow-right"></i></button>
            </div>
            <div class="zoom-controls">
                <button class="control-btn" id="zoom-out" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                <button class="control-btn" id="zoom-in" title="Zoom In"><i class="fas fa-search-plus"></i></button>
            </div>
            {% comment %} <div class="fullscreen-btn">
                <button class="control-btn" id="fullscreen" title="Fullscreen"><i class="fas fa-expand"></i></button>
            </div> {% endcomment %}
        </div>
        
        <!-- Terms and Conditions Section -->
        <div style="
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 24px;
            margin-top: 30px;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        ">
            <h3 style="
                color: #2d3748;
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 16px;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            ">
                <i class="fas fa-file-contract" style="color: #4083ff;"></i>
                Terms & Conditions
            </h3>
            <p style="
                color: #4a5568;
                line-height: 1.6;
                margin: 0;
                font-size: 14px;
                text-align: justify;
            ">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui.
            </p>
        </div>
    </div>
</div>

<!-- Bookmark Panel -->
<div id="bookmarkOverlay" class="bookmark-overlay"></div>
<div id="bookmarkPanel" class="bookmark-panel">
    <div class="bookmark-panel-header">
        <span><i class="fas fa-bookmark"></i> Bookmarks</span>
        <button id="close-bookmarks" title="Close"><i class="fas fa-times"></i></button>
    </div>
    <div class="bookmark-list" id="bookmarkList">
        <div class="bookmark-empty">
            <i class="fas fa-bookmark"></i>
            <p>No bookmarks yet</p>
            <small>Click the bookmark icon to save pages</small>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
<script>
$(document).ready(function() {
    let currentZoom = 1;
    const totalPages = parseInt("{{ total_pages }}") || 0;
    let pages = [];
    try {
        pages = JSON.parse('{{ pages|safe|escapejs }}');
    } catch(e) {
        console.error('Error parsing pages:', e);
        pages = [];
    }
    const loadedPages = new Set();
    // Preload page images
    function loadPage(pageNum) {
        if (loadedPages.has(pageNum) || pageNum < 1 || pageNum > totalPages) return;
        
        const pageDiv = $(`#flipbook .page[data-page="${pageNum}"]`);
        if (pageDiv.length && !pageDiv.find('img').length) {
            const img = $('<img>', {
                src: pages[pageNum - 1],
                alt: 'Page ' + pageNum
            });
            pageDiv.append(img);
            loadedPages.add(pageNum);
        }
    }
    
    // Load current page and surrounding pages
    function loadSurroundingPages(currentPage) {
        const isMobile = window.innerWidth <= 768;
        const range = isMobile ? 2 : 3;
        
        loadPage(currentPage);
        if (!isMobile) loadPage(currentPage + 1);
        
        for (let i = 1; i <= range; i++) {
            loadPage(currentPage + i);
            loadPage(currentPage - i);
            if (!isMobile) {
                loadPage(currentPage + i + 1);
                loadPage(currentPage - i + 1);
            }
        }
    }
    
    function initFlipbook() {
        const isMobile = window.innerWidth <= 768;
        const flipbookWidth = isMobile ? window.innerWidth * 0.9 : 900;
        const flipbookHeight = isMobile ? window.innerHeight * 0.65 : 1000;
        
        // Initialize turn.js first
        $("#flipbook").turn({
            width: flipbookWidth,
            height: flipbookHeight,
            autoCenter: true,
            acceleration: true,
            gradients: true,
            elevation: 50,
            duration: 1000,
            pages: totalPages,
            display: 'single',
            when: {
                turning: function(event, page, view) {
                    loadSurroundingPages(page);
                },
                turned: function(event, page, view) {
                    updatePageCounter(page);
                    loadSurroundingPages(page);
                }
            }
        });
        
        // Then load pages
        loadSurroundingPages(1);
        
        // After a delay, force turn.js to recalculate its dimensions
        setTimeout(function() {
            $("#flipbook").turn("size", flipbookWidth, flipbookHeight);
            $("#flipbook").turn("page", 1);
        }, 500);
        
        $('.loading-spinner').fadeOut();
        $('#flipbook-wrapper').fadeIn();
        updatePageCounter(1);
    }
    function updatePageCounter(page) {
        $('#current-page').text(page);
        $('#prev-btn, #first-btn, #prev-side-btn').prop('disabled', page <= 1);
        $('#next-btn, #last-btn, #next-side-btn').prop('disabled', page >= totalPages);
        updateBookmarkButton(page);
    }
    $('#prev-btn').click(function() { $("#flipbook").turn("previous"); });
    $('#next-btn').click(function() { $("#flipbook").turn("next"); });
    $('#prev-side-btn').click(function() { $("#flipbook").turn("previous"); });
    $('#next-side-btn').click(function() { $("#flipbook").turn("next"); });
    $('#first-btn').click(function() { $("#flipbook").turn("page", 1); });
    $('#last-btn').click(function() { $("#flipbook").turn("page", totalPages); });
    
    // Jump to page functionality
    $('#jump-page-btn').click(function() {
        const pageNum = parseInt($('#jump-page-input').val());
        if (pageNum >= 1 && pageNum <= totalPages) {
            $("#flipbook").turn("page", pageNum);
            $('#jump-page-input').val('');
        } else {
            alert('Please enter a page number between 1 and ' + totalPages);
        }
    });
    
    // Allow Enter key in input field
    $('#jump-page-input').keypress(function(e) {
        if (e.which == 13) { // Enter key
            $('#jump-page-btn').click();
        }
    });
    
    const baseWidth = 900;
    const baseHeight = 1000;
    
    $('#zoom-in').click(function() { if (currentZoom < 2) { currentZoom += 0.2; applyZoom(); } });
    $('#zoom-out').click(function() { if (currentZoom > 0.6) { currentZoom -= 0.2; applyZoom(); } });
    
    function applyZoom() {
        const isMobile = window.innerWidth <= 768;
        const newWidth = (isMobile ? window.innerWidth * 0.9 : baseWidth) * currentZoom;
        const newHeight = (isMobile ? window.innerHeight * 0.65 : baseHeight) * currentZoom;
        
        // Dynamically resize the flipbook using turn.js
        try {
            $("#flipbook").turn("size", newWidth, newHeight);
        } catch(e) {
            console.log("Zoom resize error:", e);
        }
        
        // Adjust overflow based on zoom level
        const viewerContent = $('#viewer-content');
        if (currentZoom === 1) {
            viewerContent.css({
                'overflow-y': 'auto',
                'overflow-x': 'hidden'
            });
            $('#flipbook-wrapper').css('transform', 'none');
        } else {
            viewerContent.css({
                'overflow-y': 'auto',
                'overflow-x': 'auto'
            });
        }
    }
    $('#fullscreen').click(function() {
        const element = document.getElementById('viewer-content');
        if (!document.fullscreenElement) { element.requestFullscreen(); $(this).find('i').removeClass('fa-expand').addClass('fa-compress'); }
        else { document.exitFullscreen(); $(this).find('i').removeClass('fa-compress').addClass('fa-expand'); }
    });
    $(document).keydown(function(e) {
        switch(e.which) {
            case 37: $("#flipbook").turn("previous"); break;
            case 39: $("#flipbook").turn("next"); break;
            case 36: $("#flipbook").turn("page", 1); break;
            case 35: $("#flipbook").turn("page", totalPages); break;
        }
    });
    $(window).resize(function() {
        const isMobile = window.innerWidth <= 768;
        try {
            $("#flipbook").turn("size", 
                isMobile ? window.innerWidth * 0.9 : 900,
                isMobile ? window.innerHeight * 0.65 : 1000
            );
        } catch(e) {
            console.log("Resize handling:", e);
        }
    });
    
    // ===== BOOKMARK FUNCTIONALITY =====
    const bookId = "{{ book.id }}";
    const bookmarkStorageKey = `flipbook_bookmarks_${bookId}`;
    let currentPage = 1;
    let bookmarks = JSON.parse(localStorage.getItem(bookmarkStorageKey)) || [];
    
    // Initialize bookmarks on page load
    function initBookmarks() {
        renderBookmarkList();
        updateBookmarkButton();
    }
    
    // Get all bookmarks from storage
    function getBookmarks() {
        return JSON.parse(localStorage.getItem(bookmarkStorageKey)) || [];
    }
    
    // Save bookmarks to storage
    function saveBookmarks() {
        localStorage.setItem(bookmarkStorageKey, JSON.stringify(bookmarks));
    }
    
    // Add or remove bookmark for current page
    function toggleBookmark() {
        const page = parseInt($('#current-page').text());
        const bookmarkIndex = bookmarks.findIndex(b => b.page === page);
        
        if (bookmarkIndex > -1) {
            // Remove bookmark
            bookmarks.splice(bookmarkIndex, 1);
            showNotification('Bookmark removed');
        } else {
            // Add bookmark
            bookmarks.push({
                page: page,
                title: `{{ book.title }} - Page ${page}`,
                timestamp: new Date().toLocaleString()
            });
            bookmarks.sort((a, b) => a.page - b.page);
            showNotification('Bookmark added');
        }
        
        saveBookmarks();
        renderBookmarkList();
        updateBookmarkButton();
    }
    
    // Check if current page is bookmarked
    function isPageBookmarked(page) {
        return bookmarks.some(b => b.page === page);
    }
    
    // Update bookmark button active state
    function updateBookmarkButton(page) {
        if (typeof page === 'undefined' || page === null) {
            page = parseInt($('#current-page').text());
        }
        const $btn = $('#bookmark-btn');
        bookmarks = getBookmarks();
        if (isPageBookmarked(page)) {
            $btn.addClass('active');
        } else {
            $btn.removeClass('active');
        }
    }
    
    // Render bookmark list
    function renderBookmarkList() {
        const $list = $('#bookmarkList');
        bookmarks = getBookmarks();
        
        if (bookmarks.length === 0) {
            $list.html(`
                <div class="bookmark-empty">
                    <i class="fas fa-bookmark"></i>
                    <p>No bookmarks yet</p>
                    <small>Click the bookmark icon to save pages</small>
                </div>
            `);
        } else {
            let html = '';
            bookmarks.forEach(bookmark => {
                html += `
                    <div class="bookmark-item">
                        <div class="bookmark-item-info" data-page="${bookmark.page}">
                            <div class="bookmark-item-title">Page ${bookmark.page}</div>
                            <div class="bookmark-item-page">${bookmark.timestamp}</div>
                        </div>
                        <button class="bookmark-item-delete" data-page="${bookmark.page}" title="Delete bookmark">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            });
            $list.html(html);
        }
    }
    
    // Go to bookmarked page
    function goToBookmark(page) {
        $("#flipbook").turn("page", page);
        closeBookmarkPanel();
    }
    
    // Event delegation for bookmark item clicks
    $(document).on('click', '.bookmark-item-info', function(e) {
        if (!$(e.target).closest('.bookmark-item-delete').length) {
            const page = parseInt($(this).attr('data-page'));
            goToBookmark(page);
        }
    });
    
    // Delete bookmark
    function deleteBookmark(page) {
        bookmarks = getBookmarks();
        bookmarks = bookmarks.filter(b => b.page !== page);
        saveBookmarks();
        renderBookmarkList();
        const currentPage = parseInt($('#current-page').text());
        updateBookmarkButton(currentPage);
        showNotification('Bookmark deleted');
    }
    
    // Event delegation for delete button clicks
    $(document).on('click', '.bookmark-item-delete', function(e) {
        e.stopPropagation();
        const page = parseInt($(this).attr('data-page'));
        deleteBookmark(page);
    });
    
    // Show bookmark panel
    function openBookmarkPanel() {
        $('#bookmarkPanel').addClass('open');
        $('#bookmarkOverlay').addClass('active');
        document.body.style.overflow = 'hidden';
    }
    
    // Close bookmark panel
    function closeBookmarkPanel() {
        $('#bookmarkPanel').removeClass('open');
        $('#bookmarkOverlay').removeClass('active');
        document.body.style.overflow = '';
    }
    
    // Show notification
    function showNotification(message) {
        const $notif = $(`<div style="
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10000;
            animation: slideUp 0.3s ease;
        ">${message}</div>`);
        
        $('body').append($notif);
        setTimeout(() => {
            $notif.fadeOut(300, function() { $(this).remove(); });
        }, 2000);
    }
    
    // Event listeners
    $('#bookmark-btn').click(toggleBookmark);
    $('#show-bookmarks').click(openBookmarkPanel);
    $('#close-bookmarks').click(closeBookmarkPanel);
    $('#bookmarkOverlay').click(closeBookmarkPanel);
    
    // Initialize bookmarks from localStorage on page load
    initBookmarks();
    
    setTimeout(initFlipbook, 100);
});
</script>
{% endblock %}
