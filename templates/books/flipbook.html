{% extends 'base.html' %}

{% block title %}{{ book.title }} - FlipBook{% endblock %}

{% block extra_css %}
<style>
    body { overflow: hidden; }
    .flipbook-viewer { position: fixed; top: 80px; left: 0; right: 0; bottom: 0; background: #2d3748; display: flex; flex-direction: column; }
    .viewer-header { background: rgba(153, 152, 152, 0.95); padding: 35px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; flex-wrap: wrap; }
    .bookmark-section { margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); display: flex; gap: 10px; align-items: center; }
    @media (max-width: 768px) {
        .viewer-header { flex-direction: column; align-items: stretch; gap: 10px; padding: 10px 8px; }
        .bookmark-section { margin-left: 0; padding-left: 0; border-left: none; justify-content: flex-end; }
    }
    .viewer-title { font-size: 18px; font-weight: 600; color: #333; }
    .viewer-back { text-decoration: none; color: #2c53fd; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: color 0.3s; }
    .viewer-back:hover { color: #0cb3e6; }
    .viewer-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; overflow-y: auto; overflow-x: hidden; position: relative; width: 100%; background: #FAF3E1; }
    .flipbook-container { position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; flex-shrink: 0; overflow: visible; }
    #flipbook { margin: 0 auto; }
    #flipbook .page { background: white; box-shadow: 0 0 20px rgba(0, 0, 0, 0.2); }
    #flipbook .page img { width: 100%; height: 73%; object-fit: contain; display: block; image-rendering: crisp-edges; image-rendering: -webkit-optimize-contrast; }
    /* Side Navigation Buttons */
    .side-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #125bfa4d 0%, #4083ff4d 100%); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 5px 20px rgba(18, 91, 250, 0.3); z-index: 100; }
    .side-nav-btn:hover:not(:disabled) { background: linear-gradient(135deg, #0d48a19f 0%, #2566e848 100%); transform: translateY(-50%) scale(1.1); }
    .side-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    #prev-side-btn { position: fixed; left: 20px; }
    #next-side-btn { position: fixed; right: 20px; }
    .controls { position: relative; bottom: auto; left: auto; transform: none; background: linear-gradient(135deg, #125bfa 0%, #4083ff 100%); backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 50px; display: flex; gap: 15px; align-items: center; box-shadow: 0 5px 30px rgba(250, 129, 18, 0.3); z-index: 9999; margin-bottom: 30px; flex-shrink: 0; }
    .control-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .control-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
    .control-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .page-counter { color: white; font-weight: 600; font-size: 14px; min-width: 80px; text-align: center; padding: 0 15px; }
    .jump-to-page { display: flex; gap: 6px; margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); align-items: center; }
    #jump-page-input { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 60px; padding: 8px 10px; border-radius: 6px; font-size: 13px; font-weight: 600; text-align: center; transition: all 0.3s ease; }
    #jump-page-input:focus { outline: none; background: rgba(255, 255, 255, 0.25); border-color: rgba(255, 255, 255, 0.6); }
    #jump-page-input::placeholder { color: rgba(255, 255, 255, 0.5); }
    .zoom-controls { display: flex; gap: 10px; margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); }
    .fullscreen-btn { margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); }
    .bookmark-section { margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255, 255, 255, 0.2); display: flex; gap: 10px; align-items: center; }
    .control-btn.bookmark-btn { background: rgba(255, 255, 255, 0.1); }
    .control-btn.bookmark-btn.active { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
    .bookmark-panel { position: fixed; top: 80px; right: -350px; width: 350px; height: calc(100vh - 80px); background: white; box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2); z-index: 9990; transition: right 0.3s ease; overflow-y: auto; display: flex; flex-direction: column; }
    .bookmark-panel.open { right: 0; }
    .bookmark-panel-header { padding: 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; font-weight: 700; font-size: 18px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .bookmark-panel-header button { background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .bookmark-panel-header button:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
    .bookmark-list { flex: 1; padding: 10px; overflow-y: auto; }
    .bookmark-item { padding: 12px 15px; margin-bottom: 8px; background: #f9fafb; border-left: 4px solid #fbbf24; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
    .bookmark-item:hover { background: #f3f4f6; transform: translateX(5px); box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2); }
    .bookmark-item-info { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .bookmark-item-title { font-weight: 600; color: #333; font-size: 14px; }
    .bookmark-item-page { font-size: 12px; color: #999; }
    .bookmark-item-delete { background: #fee2e2; color: #dc2626; border: none; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 14px; }
    .bookmark-item-delete:hover { background: #fecaca; }
    .bookmark-empty { text-align: center; padding: 40px 20px; color: #999; }
    .bookmark-empty i { font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5; }
    .bookmark-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0); z-index: 9989; transition: background 0.3s ease; display: none; }
    .bookmark-overlay.active { background: rgba(0, 0, 0, 0.3); display: block; }
    .loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 48px; animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
    @keyframes slideUp { from { transform: translateX(-50%) translateY(20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
    @media (max-width: 768px) {
        .flipbook-viewer { top: 70px; }
        .viewer-header { padding: 60px 15px; }
        .viewer-header { margin: 0px 0px -53px; }
        .viewer-title { font-size: 16px; }
        .viewer-content { padding: 10px; flex-direction: column; }
        .flipbook-container { max-width: 100%; max-height: 75vh; padding: 0 10px; overflow: visible; }
        #prev-side-btn { display: flex !important; width: 40px; height: 40px; font-size: 16px; left: 10px; z-index: 1000; }
        #next-side-btn { display: flex !important; width: 40px; height: 40px; font-size: 16px; right: 10px; z-index: 1000; }
        .controls {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 8px;
            gap: 4px;
            flex-wrap: nowrap;
            justify-content: flex-start;
            border-radius: 25px;
            width: 98vw;
            max-width: 100vw;
            margin: 0;
            overflow-x: auto;
            overflow-y: visible;
            display: flex;
            align-items: center;
            scrollbar-width: none;
        }
        .controls::-webkit-scrollbar { display: none; }
        .jump-to-page { display: flex; min-width: 120px; }
        .jump-to-page input { min-width: 60px; }
        .page-counter { min-width: 60px; }
        .zoom-controls { min-width: 80px; }
        .control-btn { width: 38px; height: 38px; font-size: 13px; flex-shrink: 0; min-width: 38px; }
        .page-counter { font-size: 12px; min-width: 65px; padding: 0 10px; flex-shrink: 0; white-space: nowrap; }
        /* .jump-to-page { display: none; } */
        .zoom-controls { margin-left: 5px; padding-left: 5px; border-left: 1px solid rgba(255, 255, 255, 0.2); gap: 5px; }
        .fullscreen-btn { margin-left: 5px; padding-left: 5px; border-left: 1px solid rgba(255, 255, 255, 0.2); }
    }
    @media (max-width: 480px) {
        .flipbook-viewer { top: 60px; }
        .flipbook-container { padding: 0 10px; max-height: 70vh; }
        #prev-side-btn { width: 38px; height: 38px; font-size: 14px; left: 8px; }
        #next-side-btn { width: 38px; height: 38px; font-size: 14px; right: 8px; }
        .controls {
            bottom: 8px;
            padding: 8px 4px;
            gap: 3px;
            width: 99vw;
            max-width: 100vw;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: visible;
            display: flex;
            align-items: center;
            scrollbar-width: none;
        }
        .controls::-webkit-scrollbar { display: none; }
        .jump-to-page { min-width: 110px; }
        .jump-to-page input { min-width: 50px; }
        .page-counter { min-width: 50px; }
        .zoom-controls { min-width: 60px; }
        .control-btn { width: 36px; height: 36px; font-size: 12px; min-width: 36px; }
        .page-counter { font-size: 11px; min-width: 55px; padding: 0 5px; }
        .zoom-controls { margin-left: 3px; padding-left: 3px; gap: 3px; }
        .zoom-controls .control-btn { display: inline-flex; }
        .fullscreen-btn { margin-left: 3px; padding-left: 3px; }
    }

    /* ===== SECURITY PROTECTIONS ===== */
    /* 1) TAB FOCUS BLUR PROTECTION */
    .security-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0, 0, 0, 0.8); display: none; z-index: 99999; 
        align-items: center; justify-content: center; 
        backdrop-filter: blur(8px); animation: fadeIn 0.3s ease;
    }
    .security-overlay.active { display: flex; }
    .security-overlay-content { 
        background: white; padding: 40px; border-radius: 12px; 
        text-align: center; max-width: 450px; 
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .security-overlay-icon { font-size: 48px; margin-bottom: 15px; color: #ef4444; }
    .security-overlay-title { font-size: 22px; font-weight: 700; color: #1f2937; margin-bottom: 10px; }
    .security-overlay-message { font-size: 14px; color: #6b7280; line-height: 1.5; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Tab blur filter on content */
    .flipbook-viewer.is-blurred { filter: blur(12px); pointer-events: none; }

    /* 2) ZOOM HARDENING WARNING */
    .zoom-warning { 
        position: fixed; top: 100px; left: 50%; transform: translateX(-50%); 
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
        color: #78350f; padding: 12px 20px; border-radius: 8px; 
        box-shadow: 0 8px 20px rgba(251, 191, 36, 0.4); 
        z-index: 9999; display: none; font-weight: 600; font-size: 14px;
        animation: slideDown 0.4s ease;
    }
    .zoom-warning.show { display: flex; gap: 10px; align-items: center; }
    @keyframes slideDown { from { transform: translateX(-50%) translateY(-30px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

    /* Subtle blur when high zoom detected */
    .flipbook-viewer.zoom-blurred #flipbook .page img { 
        filter: blur(1.2px); 
        opacity: 0.98;
    }

    /* 3) ANTI-OCR NOISE OVERLAY - invisible to human eye */
    #flipbook .page { position: relative; }
    #flipbook .page::after { 
        content: ''; 
        position: absolute; top: 0; left: 0; 
        width: 100%; height: 100%; 
        background-image: url("data:image/svg+xml,%3Csvg width='64' height='64' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' result='noise'/%3E%3CfeColorMatrix in='noise' type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='64' height='64' filter='url(%23noise)' opacity='0.035'/%3E%3C/svg%3E"); 
        background-size: 128px 128px;
        pointer-events: none; 
        z-index: 5;
        mix-blend-mode: overlay;
    }
    /* Randomize noise position per page */
    #flipbook .page:nth-child(odd)::after { background-position: 0 0; }
    #flipbook .page:nth-child(4n)::after { background-position: 12px 8px; }
    #flipbook .page:nth-child(3n)::after { background-position: 8px 12px; }
</style>
{% endblock %}

{% block content %}

<!-- SECURITY: Overlay shown when tab loses focus -->
<div class="security-overlay" id="securityOverlay">
    <div class="security-overlay-content">
        <div class="security-overlay-icon"><i class="fas fa-lock"></i></div>
        <div class="security-overlay-title">Content Protected</div>
        <div class="security-overlay-message">
            This document is hidden when you switch tabs to prevent unauthorized viewing.
        </div>
    </div>
</div>

<!-- SECURITY: Warning banner for high zoom -->
<div class="zoom-warning" id="zoomWarning">
    <i class="fas fa-exclamation-triangle"></i>
    <span>High zoom detected - content protection activated</span>
</div>

<div class="flipbook-viewer" id="flipbookViewer">
    <div class="viewer-header">
        <a href="{% url 'home' %}" class="viewer-back"><i class="fas fa-arrow-left"></i> Back to Library</a>
        <div class="viewer-title">{{ book.title }}</div>
        <div class="bookmark-section" style="margin-left:auto; display:flex; gap:10px; align-items:center;">
            <button class="control-btn bookmark-btn" id="bookmark-btn" title="Add Bookmark"><i class="fas fa-bookmark"></i></button>
            <button class="control-btn" id="show-bookmarks" title="Show Bookmarks"><i class="fas fa-bars"></i></button>
        </div>
    </div>
    <div class="viewer-content" id="viewer-content">
        <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
        <div class="flipbook-container" id="flipbook-wrapper" style="display: none;">
            <button class="side-nav-btn" id="prev-side-btn" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
            <div id="flipbook">
                {% for page in pages_list %}
                <div class="page" data-page="{{ forloop.counter }}"></div>
                {% endfor %}
            </div>
            <button class="side-nav-btn" id="next-side-btn" title="Next Page"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="controls">
            <button class="control-btn" id="prev-btn" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
            {% comment %} <button class="control-btn" id="first-btn" title="First Page"><i class="fas fa-step-backward"></i></button> {% endcomment %}
            <div class="page-counter"><span id="current-page">1</span> / <span id="total-pages">{{ total_pages }}</span></div>
            {% comment %} <button class="control-btn" id="last-btn" title="Last Page"><i class="fas fa-step-forward"></i></button> {% endcomment %}
            <button class="control-btn" id="next-btn" title="Next Page"><i class="fas fa-chevron-right"></i></button>
            <div class="jump-to-page">
                <input type="number" id="jump-page-input" placeholder="Go to page" title="Jump to Page" min="1" max="{{ total_pages }}">
                <button class="control-btn" id="jump-page-btn" title="Jump to Page"><i class="fas fa-arrow-right"></i></button>
            </div>
            <div class="zoom-controls">
                <button class="control-btn" id="zoom-out" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                <button class="control-btn" id="zoom-in" title="Zoom In"><i class="fas fa-search-plus"></i></button>
            </div>
            {% comment %} <div class="fullscreen-btn">
                <button class="control-btn" id="fullscreen" title="Fullscreen"><i class="fas fa-expand"></i></button>
            </div> {% endcomment %}
        </div>
        
        <!-- Terms and Conditions Section -->
        <div style="
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 24px;
            margin-top: 30px;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        ">
            <h3 style="
                color: #2d3748;
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 16px;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            ">
                <i class="fas fa-file-contract" style="color: #4083ff;"></i>
                Terms & Conditions
            </h3>
            <p style="
                color: #4a5568;
                line-height: 1.6;
                margin: 0;
                font-size: 14px;
                text-align: justify;
            ">
               Legal Caution  : 

            Pls dont forward this Pdf to anywhere to any Individual, group or any Organization. Do not resale or distribute this  Pdf commercially or in kind to any person, group or organization. Do not use this  Pdf in non-social way or for any non-social purpose or reason. This act is illegal and is punishable under Digital Assets Privacy Law & Cyber Crime Laws of India. 

            àª† àª¬àª¾àª¯à«‹àª¡à«‡àªŸàª¾ àª¬à«àª•àª²à«‡àªŸ  àª«àª¿àªàª¿àª•àª² àª•à«‡ àª¡àª¿àªœàª¿àªŸàª² (àªªà«€àª¡à«€àªàª«  àª•à«‡ àª…àª¨à«àª¯ ) àª•à«‹àªªà«€ àª¬àª¨àª¾àªµà«€àª¨à«‡ àªµà«‡àªšàª¾àª£ àª•à«‡ àª…àª¨à«àª¯ àª°à«€àª¤à«‡ àªµàª¿àª¤àª°àª£ àª•àª°àªµà«àª‚ àª¤à«‡ àª—à«‡àª° àª•àª¾àª¨à«‚àª¨à«€ àª›à«‡ . àªœà«‹ àª•à«‹àªˆ àªµà«àª¯àª•à«àª¤àª¿ àª•à«‡ àª¸àª‚àª¸à«àª¥àª¾ àª†àªµà«àª‚ àª•àª°àª¶à«‡ àª¤à«‹ àª¤à«‡ àªµà«àª¯àª•à«àª¤àª¿ àª•à«‡ àª¸àª‚àª¸à«àª¥àª¾ àªµàª¿àª°à«àª¦à«àª§ àª¸àª–àª¤ àª•àª¾àª¨à«‚àª¨à«€ àªªàª—àª²àª¾àª‚ àª²à«‡àªµàª¾àª®àª¾àª‚ àª†àªµàª¶à«‡. àª•àª¾àª¨à«‚àª¨à«€ àªœà«‹àª—àªµàª¾àªˆ àªªà«àª°àª®àª¾àª£à«‡ àª† àª•à«ƒàª¤à«àª¯ àª¸àª–àª¤ àª¸àªœàª¾àª¨à«‡ àªªàª¾àª¤à«àª° àª›à«‡, àª† àª¬àª¾àª¯à«‹àª¡à«‡àªŸàª¾ àªªà«€àª¡à«€àªàª«  àª…àª¨à«‡ àª¤à«‡àª¨àª¾ àª¡à«‡àªŸàª¾àª¨à«‹ àª®àª¾àª¤à«àª° àª¸àª¾àª®àª¾àªœàª¿àª• àª•àª¾àª°à«àª¯ àª®àª¾àªŸà«‡ àª‰àªªàª¯à«‹àª— àª•àª°àªµà«‹, àª•à«‹àªˆàªªàª£ àªµà«àª¯àª•à«àª¤àª¿ àª•à«‡ àª¸àª‚àª¸à«àª¥àª¾àª àª† àª¬à«àª•àª²à«‡àªŸàª¨à«‹ àª•à«‹àª®àª°à«àª¶à«€àª¯àª² àª‰àªªàª¯à«‹àª— àª•àª°àªµà«‹ àª¨àª¹àª¿ àª…àª¨à«àª¯àª¥àª¾ àª¤à«‡ àªµà«àª¯àª•à«àª¤àª¿ àª•à«‡ àª¸àª‚àª¸à«àª¥àª¾ àªµàª¿àª°à«àª¦à«àª§ àª•àª¾àª¨à«‚àª¨à«€ àªªàª—àª²àª¾àª‚ àª²à«‡àªµàª¾àª®àª¾àª‚ àª†àªµàª¶à«‡. 

            àª­à«‚àª¦à«‡àªµ àª¨à«‡àªŸàªµàª°à«àª• - Legal Team 
            àª…àª®àª¦àª¾àªµàª¾àª¦, àªµàª¡à«‹àª¦àª°àª¾

            From Bhudev Network
            </p>
        </div>
    </div>
</div>

<!-- Bookmark Panel -->
<div id="bookmarkOverlay" class="bookmark-overlay"></div>
<div id="bookmarkPanel" class="bookmark-panel">
    <div class="bookmark-panel-header">
        <span><i class="fas fa-bookmark"></i> Bookmarks</span>
        <button id="close-bookmarks" title="Close"><i class="fas fa-times"></i></button>
    </div>
    <div class="bookmark-list" id="bookmarkList">
        <div class="bookmark-empty">
            <i class="fas fa-bookmark"></i>
            <p>No bookmarks yet</p>
            <small>Click the bookmark icon to save pages</small>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
<script>
$(document).ready(function() {
    let currentZoom = 1;
    const totalPages = parseInt("{{ total_pages }}") || 0;
    let pages = [];
    try {
        pages = JSON.parse('{{ pages|safe|escapejs }}');
    } catch(e) {
        console.error('Error parsing pages:', e);
        pages = [];
    }
    const loadedPages = new Set();
    
    // ===== SECURITY PROTECTIONS MODULE =====
    // Comprehensive content protection system for secure PDF viewing
    
    const SecurityManager = {
        config: {
            tabFocusProtection: true,      // Blur when tab loses focus
            zoomHardeningEnabled: true,    // Protect against zoom screenshots
            zoomThreshold: 1.25,           // Trigger blur at 125% zoom (1.25 DPR)
            antiOCREnabled: true,          // Noise overlay (CSS-based)
            enableConsoleLogging: true,    // Log security events
        },

        /**
         * 1) TAB FOCUS BLUR PROTECTION
         * Detects when user switches tabs or window loses focus
         * Uses: document.visibilitychange, window.blur, window.focus events
         * Action: Applies blur filter + shows security overlay
         */
        initTabFocusProtection() {
            if (!this.config.tabFocusProtection) return;

            // Detect visibility change (tab switch, window minimize)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    this.activateBlur('Tab switched - content blurred');
                } else {
                    this.deactivateBlur('Tab refocused - content visible');
                }
            });

            // Detect window blur (click to another app)
            window.addEventListener('blur', () => {
                this.activateBlur('Window lost focus - content blurred');
            });

            // Detect window focus (return to app)
            window.addEventListener('focus', () => {
                if (!document.hidden) {
                    this.deactivateBlur('Window refocused - content visible');
                }
            });
        },

        activateBlur(event) {
            const viewer = $('#flipbookViewer');
            const overlay = $('#securityOverlay');
            
            viewer.addClass('is-blurred');
            overlay.addClass('active');
            
            if (this.config.enableConsoleLogging) {
                console.warn('ğŸ” SECURITY:', event);
            }
        },

        deactivateBlur(event) {
            const viewer = $('#flipbookViewer');
            const overlay = $('#securityOverlay');
            
            viewer.removeClass('is-blurred');
            overlay.removeClass('active');
            
            if (this.config.enableConsoleLogging) {
                console.log('âœ“', event);
            }
        },

        /**
         * 2) ZOOM HARDENING
         * Monitors screen zoom level (window.devicePixelRatio)
         * Prevents high-quality cropped screenshots via zoom
         * Triggers blur overlay when zoom exceeds safe threshold
         * Applies to: Browser zoom (Ctrl+Scroll), System zoom, Display scaling
         */
        lastDPR: window.devicePixelRatio,

        initZoomHardening() {
            if (!this.config.zoomHardeningEnabled) return;

            // Check zoom on every resize event
            window.addEventListener('resize', () => this.checkZoomLevel());

            // Check zoom on keyboard zoom shortcut (Ctrl/Cmd + Scroll)
            document.addEventListener('wheel', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    setTimeout(() => this.checkZoomLevel(), 50);
                }
            }, { passive: true });

            // Check zoom on keyboard shortcuts (Ctrl +/-)
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '0')) {
                    setTimeout(() => this.checkZoomLevel(), 50);
                }
            });

            // Initial check
            this.checkZoomLevel();
        },

        checkZoomLevel() {
            const currentDPR = window.devicePixelRatio;
            
            // Detect significant zoom changes
            if (Math.abs(currentDPR - this.lastDPR) > 0.05) {
                this.lastDPR = currentDPR;
                
                if (currentDPR > this.config.zoomThreshold) {
                    this.activateZoomProtection(currentDPR);
                } else {
                    this.deactivateZoomProtection();
                }
            }
        },

        activateZoomProtection(dprLevel) {
            const viewer = $('#flipbookViewer');
            const warning = $('#zoomWarning');
            
            viewer.addClass('zoom-blurred');
            warning.addClass('show');
            
            if (this.config.enableConsoleLogging) {
                console.warn(`âš ï¸ SECURITY: High zoom detected (${Math.round(dprLevel * 100)}%) - blur applied`);
            }
        },

        deactivateZoomProtection() {
            const viewer = $('#flipbookViewer');
            const warning = $('#zoomWarning');
            
            viewer.removeClass('zoom-blurred');
            warning.removeClass('show');
        },

        /**
         * 3) ANTI-OCR NOISE OVERLAY
         * Adds imperceptible noise texture overlay to all pages
         * Uses SVG-based fractal noise with 0.035 opacity
         * Implemented via CSS ::after pseudo-elements
         * Position randomized per page: odd, 4n, 3n patterns
         * Reduces OCR (Optical Character Recognition) effectiveness
         * Invisible to human eyes (opacity < 0.05)
         */
        initAntiOCR() {
            if (!this.config.antiOCREnabled) return;
            // Noise is purely CSS-based - no JS needed
            // See CSS for #flipbook .page::after implementation
            if (this.config.enableConsoleLogging) {
                console.log('âœ“ SECURITY: Anti-OCR noise overlay active');
            }
        },

        /**
         * Initialize all security protections
         */
        init() {
            this.initTabFocusProtection();
            this.initZoomHardening();
            this.initAntiOCR();
            
            if (this.config.enableConsoleLogging) {
                console.log('ğŸ”’ All security protections initialized');
            }
        }
    };

    // Initialize security protections
    SecurityManager.init();

    /**
     * ADDITIONAL PROTECTIONS
     */
    
    // Disable right-click context menu
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
    });

    // Disable text selection on flipbook
    $('#flipbook').css({
        'user-select': 'none',
        '-webkit-user-select': 'none',
        '-moz-user-select': 'none',
        '-ms-user-select': 'none'
    });

    // ===== END SECURITY PROTECTIONS =====
    
    // Preload page images
    function loadPage(pageNum) {
        if (loadedPages.has(pageNum) || pageNum < 1 || pageNum > totalPages) return;
        
        const pageDiv = $(`#flipbook .page[data-page="${pageNum}"]`);
        if (pageDiv.length && !pageDiv.find('img').length) {
            const img = $('<img>', {
                src: pages[pageNum - 1],
                alt: 'Page ' + pageNum
            });
            pageDiv.append(img);
            loadedPages.add(pageNum);
        }
    }
    
    // Load current page and surrounding pages
    function loadSurroundingPages(currentPage) {
        const isMobile = window.innerWidth <= 768;
        const range = isMobile ? 2 : 3;
        
        loadPage(currentPage);
        if (!isMobile) loadPage(currentPage + 1);
        
        for (let i = 1; i <= range; i++) {
            loadPage(currentPage + i);
            loadPage(currentPage - i);
            if (!isMobile) {
                loadPage(currentPage + i + 1);
                loadPage(currentPage - i + 1);
            }
        }
    }
    
    function initFlipbook() {
        const isMobile = window.innerWidth <= 768;
        const flipbookWidth = isMobile ? window.innerWidth * 0.9 : 900;
        const flipbookHeight = isMobile ? window.innerHeight * 0.65 : 1000;
        
        // Initialize turn.js first
        $("#flipbook").turn({
            width: flipbookWidth,
            height: flipbookHeight,
            autoCenter: true,
            acceleration: true,
            gradients: true,
            elevation: 50,
            duration: 1000,
            pages: totalPages,
            display: 'single',
            when: {
                turning: function(event, page, view) {
                    loadSurroundingPages(page);
                },
                turned: function(event, page, view) {
                    updatePageCounter(page);
                    loadSurroundingPages(page);
                }
            }
        });
        
        // Then load pages
        loadSurroundingPages(1);
        
        // After a delay, force turn.js to recalculate its dimensions
        setTimeout(function() {
            $("#flipbook").turn("size", flipbookWidth, flipbookHeight);
            $("#flipbook").turn("page", 1);
        }, 500);
        
        $('.loading-spinner').fadeOut();
        $('#flipbook-wrapper').fadeIn();
        updatePageCounter(1);
    }
    function updatePageCounter(page) {
        $('#current-page').text(page);
        $('#prev-btn, #first-btn, #prev-side-btn').prop('disabled', page <= 1);
        $('#next-btn, #last-btn, #next-side-btn').prop('disabled', page >= totalPages);
        updateBookmarkButton(page);
    }
    $('#prev-btn').click(function() { $("#flipbook").turn("previous"); });
    $('#next-btn').click(function() { $("#flipbook").turn("next"); });
    $('#prev-side-btn').click(function() { $("#flipbook").turn("previous"); });
    $('#next-side-btn').click(function() { $("#flipbook").turn("next"); });
    $('#first-btn').click(function() { $("#flipbook").turn("page", 1); });
    $('#last-btn').click(function() { $("#flipbook").turn("page", totalPages); });
    
    // Jump to page functionality
    $('#jump-page-btn').click(function() {
        const pageNum = parseInt($('#jump-page-input').val());
        if (pageNum >= 1 && pageNum <= totalPages) {
            $("#flipbook").turn("page", pageNum);
            $('#jump-page-input').val('');
        } else {
            alert('Please enter a page number between 1 and ' + totalPages);
        }
    });
    
    // Allow Enter key in input field
    $('#jump-page-input').keypress(function(e) {
        if (e.which == 13) { // Enter key
            $('#jump-page-btn').click();
        }
    });
    
    const baseWidth = 900;
    const baseHeight = 1000;
    
    $('#zoom-in').click(function() { if (currentZoom < 2) { currentZoom += 0.2; applyZoom(); } });
    $('#zoom-out').click(function() { if (currentZoom > 0.6) { currentZoom -= 0.2; applyZoom(); } });
    
    function applyZoom() {
        const isMobile = window.innerWidth <= 768;
        const newWidth = (isMobile ? window.innerWidth * 0.9 : baseWidth) * currentZoom;
        const newHeight = (isMobile ? window.innerHeight * 0.65 : baseHeight) * currentZoom;
        
        // Dynamically resize the flipbook using turn.js
        try {
            $("#flipbook").turn("size", newWidth, newHeight);
        } catch(e) {
            console.log("Zoom resize error:", e);
        }
        
        // Adjust overflow based on zoom level
        const viewerContent = $('#viewer-content');
        if (currentZoom === 1) {
            viewerContent.css({
                'overflow-y': 'auto',
                'overflow-x': 'hidden'
            });
            $('#flipbook-wrapper').css('transform', 'none');
        } else {
            viewerContent.css({
                'overflow-y': 'auto',
                'overflow-x': 'auto'
            });
        }
    }
    $('#fullscreen').click(function() {
        const element = document.getElementById('viewer-content');
        if (!document.fullscreenElement) { element.requestFullscreen(); $(this).find('i').removeClass('fa-expand').addClass('fa-compress'); }
        else { document.exitFullscreen(); $(this).find('i').removeClass('fa-compress').addClass('fa-expand'); }
    });
    $(document).keydown(function(e) {
        switch(e.which) {
            case 37: $("#flipbook").turn("previous"); break;
            case 39: $("#flipbook").turn("next"); break;
            case 36: $("#flipbook").turn("page", 1); break;
            case 35: $("#flipbook").turn("page", totalPages); break;
        }
    });
    $(window).resize(function() {
        const isMobile = window.innerWidth <= 768;
        try {
            $("#flipbook").turn("size", 
                isMobile ? window.innerWidth * 0.9 : 900,
                isMobile ? window.innerHeight * 0.65 : 1000
            );
        } catch(e) {
            console.log("Resize handling:", e);
        }
    });
    
    // ===== BOOKMARK FUNCTIONALITY =====
    const bookId = "{{ book.id }}";
    const bookmarkStorageKey = `flipbook_bookmarks_${bookId}`;
    let currentPage = 1;
    let bookmarks = JSON.parse(localStorage.getItem(bookmarkStorageKey)) || [];
    
    // Initialize bookmarks on page load
    function initBookmarks() {
        renderBookmarkList();
        updateBookmarkButton();
    }
    
    // Get all bookmarks from storage
    function getBookmarks() {
        return JSON.parse(localStorage.getItem(bookmarkStorageKey)) || [];
    }
    
    // Save bookmarks to storage
    function saveBookmarks() {
        localStorage.setItem(bookmarkStorageKey, JSON.stringify(bookmarks));
    }
    
    // Add or remove bookmark for current page
    function toggleBookmark() {
        const page = parseInt($('#current-page').text());
        const bookmarkIndex = bookmarks.findIndex(b => b.page === page);
        
        if (bookmarkIndex > -1) {
            // Remove bookmark
            bookmarks.splice(bookmarkIndex, 1);
            showNotification('Bookmark removed');
        } else {
            // Add bookmark
            bookmarks.push({
                page: page,
                title: `{{ book.title }} - Page ${page}`,
                timestamp: new Date().toLocaleString()
            });
            bookmarks.sort((a, b) => a.page - b.page);
            showNotification('Bookmark added');
        }
        
        saveBookmarks();
        renderBookmarkList();
        updateBookmarkButton();
    }
    
    // Check if current page is bookmarked
    function isPageBookmarked(page) {
        return bookmarks.some(b => b.page === page);
    }
    
    // Update bookmark button active state
    function updateBookmarkButton(page) {
        if (typeof page === 'undefined' || page === null) {
            page = parseInt($('#current-page').text());
        }
        const $btn = $('#bookmark-btn');
        bookmarks = getBookmarks();
        if (isPageBookmarked(page)) {
            $btn.addClass('active');
        } else {
            $btn.removeClass('active');
        }
    }
    
    // Render bookmark list
    function renderBookmarkList() {
        const $list = $('#bookmarkList');
        bookmarks = getBookmarks();
        
        if (bookmarks.length === 0) {
            $list.html(`
                <div class="bookmark-empty">
                    <i class="fas fa-bookmark"></i>
                    <p>No bookmarks yet</p>
                    <small>Click the bookmark icon to save pages</small>
                </div>
            `);
        } else {
            let html = '';
            bookmarks.forEach(bookmark => {
                html += `
                    <div class="bookmark-item">
                        <div class="bookmark-item-info" data-page="${bookmark.page}">
                            <div class="bookmark-item-title">Page ${bookmark.page}</div>
                            <div class="bookmark-item-page">${bookmark.timestamp}</div>
                        </div>
                        <button class="bookmark-item-delete" data-page="${bookmark.page}" title="Delete bookmark">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            });
            $list.html(html);
        }
    }
    
    // Go to bookmarked page
    function goToBookmark(page) {
        $("#flipbook").turn("page", page);
        closeBookmarkPanel();
    }
    
    // Event delegation for bookmark item clicks
    $(document).on('click', '.bookmark-item-info', function(e) {
        if (!$(e.target).closest('.bookmark-item-delete').length) {
            const page = parseInt($(this).attr('data-page'));
            goToBookmark(page);
        }
    });
    
    // Delete bookmark
    function deleteBookmark(page) {
        bookmarks = getBookmarks();
        bookmarks = bookmarks.filter(b => b.page !== page);
        saveBookmarks();
        renderBookmarkList();
        const currentPage = parseInt($('#current-page').text());
        updateBookmarkButton(currentPage);
        showNotification('Bookmark deleted');
    }
    
    // Event delegation for delete button clicks
    $(document).on('click', '.bookmark-item-delete', function(e) {
        e.stopPropagation();
        const page = parseInt($(this).attr('data-page'));
        deleteBookmark(page);
    });
    
    // Show bookmark panel
    function openBookmarkPanel() {
        $('#bookmarkPanel').addClass('open');
        $('#bookmarkOverlay').addClass('active');
        document.body.style.overflow = 'hidden';
    }
    
    // Close bookmark panel
    function closeBookmarkPanel() {
        $('#bookmarkPanel').removeClass('open');
        $('#bookmarkOverlay').removeClass('active');
        document.body.style.overflow = '';
    }
    
    // Show notification
    function showNotification(message) {
        const $notif = $(`<div style="
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10000;
            animation: slideUp 0.3s ease;
        ">${message}</div>`);
        
        $('body').append($notif);
        setTimeout(() => {
            $notif.fadeOut(300, function() { $(this).remove(); });
        }, 2000);
    }
    
    // Event listeners
    $('#bookmark-btn').click(toggleBookmark);
    $('#show-bookmarks').click(openBookmarkPanel);
    $('#close-bookmarks').click(closeBookmarkPanel);
    $('#bookmarkOverlay').click(closeBookmarkPanel);
    
    // Initialize bookmarks from localStorage on page load
    initBookmarks();
    
    setTimeout(initFlipbook, 100);
});
</script>
{% endblock %}
